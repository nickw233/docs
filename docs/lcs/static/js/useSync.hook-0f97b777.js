import{u as M,as as V,aI as p,aT as C,dm as B,dn as G,R as h,aG as $,I as g,aH as D,a5 as k,dp as H,Z as x,dg as T}from"./index-3cca530d.js";import{u as J,a as K,P as E,g as l,C as U,h as j,B as v,f as R}from"./chartEditStore-eacdd3b3.js";import{u as q,C as N}from"./chartLayoutStore-42609aea.js";import{f as Q,d as Z,e as b}from"./index-e27881ef.js";import{b as z,u as w,s as W,f as X}from"./project.api-cdb3f370.js";const Y=t=>t,tt=(t,n)=>{try{if(n.id){const f="vnodeBeforeMount"in n.events,i="vnodeMounted"in n.events;return f&&(t.events.advancedEvents.vnodeBeforeMount=n?.events.vnodeBeforeMount),i&&(t.events.advancedEvents.vnodeMounted=n?.events.vnodeMounted),(f||i)&&(n.events={baseEvent:{[v.ON_CLICK]:void 0,[v.ON_DBL_CLICK]:void 0,[v.ON_MOUSE_ENTER]:void 0,[v.ON_MOUSE_LEAVE]:void 0},advancedEvents:{[R.VNODE_MOUNTED]:void 0,[R.VNODE_BEFORE_MOUNT]:void 0},interactEvents:[]}),t}}catch{return t}},u=(t,n,f=!1)=>{if(tt(t,n),f)return T(t,n);const i=n.option;if(!i)return T(t,n);if(n.option=void 0,i)return{...T(t,n),option:i}},it=()=>{const t=J(),n=K(),f=M(),i=q(),A=async(a,c=!1,d=!1)=>{c&&(t.componentList=[],n.clearBackStack(),n.clearForwardStack()),a.editCanvasConfig=Y(a.editCanvasConfig),a.componentList.forEach(async e=>{const r=o=>{window.$vue.component(o.chartConfig.chartKey)||(window.$vue.component(o.chartConfig.chartKey,Q(o.chartConfig)),window.$vue.component(o.chartConfig.conKey,Z(o.chartConfig)))};e.isGroup?e.groupList.forEach(o=>{r(o)}):r(e)});const S=async(e,r)=>{let o=await b(e.chartConfig);e.chartConfig.redirectComponent&&(e.chartConfig.dataset&&(o.option.dataset=e.chartConfig.dataset),o.chartConfig.title=e.chartConfig.title,o.chartConfig.chartFrame=e.chartConfig.chartFrame),r?r(d?u(o,{...e,id:g()}):u(o,e)):d?t.addComponentList(u(o,{...e,id:g()}),!1,!0):t.addComponentList(u(o,e),!1,!0)};for(const e in a)if(e===U.COMPONENT_LIST){let r=0;const o=a[e].length;for(const s of a[e]){let L=parseInt((parseFloat(`${++r/o}`)*100).toString());if(i.setItemUnHandle(N.PERCENTAGE,L),s.isGroup){let m=new j;d?m=u(m,{...s,id:g()}):m=u(m,s);const P=[];for(const O of s.groupList)await S(O,F=>{P.push(F)});m.groupList=P,t.addComponentList(m,!1,!0)}else await S(s);L===100&&(n.clearBackStack(),n.clearForwardStack())}}else(e===U.EDIT_CANVAS_CONFIG||e===U.REQUEST_GLOBAL_CONFIG)&&u(t[e],a[e],!0);i.setItemUnHandle(N.PERCENTAGE,0)},I=a=>{const{id:c,projectName:d,remarks:S,indexImage:e,state:r}=a;t.setProjectInfo(E.PROJECT_ID,c),t.setProjectInfo(E.PROJECT_NAME,d),t.setProjectInfo(E.REMARKS,S),t.setProjectInfo(E.THUMBNAIL,e),t.setProjectInfo(E.RELEASE,r===1)},_=async()=>{t.componentList=[],t.setEditCanvas(l.SAVE_STATUS,C.START);try{const a=await X({projectId:p()});if(a&&a.code===h.SUCCESS){if(a.data){I(a.data),await A(D(a.data.content));return}else t.setProjectInfo(E.PROJECT_ID,p());setTimeout(()=>{t.setEditCanvas(l.SAVE_STATUS,C.SUCCESS)},1e3);return}t.setEditCanvas(l.SAVE_STATUS,C.FAILURE)}catch{t.setEditCanvas(l.SAVE_STATUS,C.FAILURE),k()}},y=V(async(a=!0)=>{if(!p())return;let c=t.getProjectInfo[E.PROJECT_ID];if(c===null||c===""){window.$message.error("数据初未始化成功,请刷新页面！");return}t.setEditCanvas(l.SAVE_STATUS,C.START);try{if(a){const e=document.querySelector(".go-edit-range"),r=await B(e,{backgroundColor:null,allowTaint:!0,useCORS:!0});let o=new FormData;o.append("object",G(r.toDataURL(),`${p()}_index_preview.png`));const s=await z(o);s&&s.code===h.SUCCESS&&(s.data.fileurl?await w({id:p(),indexImage:`${s.data.fileurl}`}):await w({id:p(),indexImage:`${f.getFetchInfo.OSSUrl}${s.data.fileName}`}))}}catch(e){console.log(e)}let d=new FormData;d.append("projectId",c),d.append("content",$(t.getStorageInfo()||{}));const S=await W(d);if(S&&S.code===h.SUCCESS){setTimeout(()=>{t.setEditCanvas(l.SAVE_STATUS,C.SUCCESS)},1e3);return}t.setEditCanvas(l.SAVE_STATUS,C.FAILURE)},3e3);return{updateComponent:A,updateStoreInfo:I,dataSyncFetch:_,dataSyncUpdate:y,intervalDataSyncUpdate:()=>{const a=setInterval(()=>{y()},H*1e3);x(()=>{clearInterval(a)})}}};export{it as u};
