import{d as _e,W as ce,b as g,Y as ee,a8 as Ee,dO as te,H as ve,m as s,o as c,c as w,k as r,B as T,w as t,j as e,q as a,h as i,F as U,bS as Re,a7 as pe,a as ge,a9 as Ue,dI as ze,aH as He,dG as $e,aG as je,aK as Ie,a_ as fe,n as P,t as j,a2 as se,N as Ne,O as Ve,be as qe}from"./index-3cca530d.js";import{e as Q}from"./chartEditStore-eacdd3b3.js";import{g as re}from"./plugin-ede68460.js";import{i as le}from"./icon-8135a16a.js";import{T as Z,D as I}from"./index-be9f40e9.js";import{u as ye}from"./useTargetData.hook-52978307.js";import{M as we}from"./EditorWorker-af30b26c.js";import"./editorWorker-259d4dbf.js";import{F as me}from"./fileTypeEnum-21359a08.js";const Ae={class:"go-ml-4"},De={class:"editor-data-show"},Oe={class:"editor-data-show"},Be={class:"editor-data-show"},Le={class:"go-flex-items-center"},Pe=_e({__name:"index",setup(N){const{DocumentTextIcon:d}=le.ionicons5,{FilterIcon:M,FilterEditIcon:G}=le.carbon,{targetData:y,chartEditStore:x}=ye();ce(y.value.request),ce(x.getRequestGlobalConfig);const _=g(!1),k=g(y.value.filter||"return data"),V=g(!1),p=g(""),J=async()=>{try{const f=await Re(pe(y.value.request),pe(x.getRequestGlobalConfig));if(f){p.value=f;return}window.$message.warning("没有拿到返回值，请检查接口！")}catch(f){console.error(f),window.$message.warning("数据异常，请检查参数！")}},E=ee(()=>{try{const f=new Function("data","res",k.value),n=Ee(p.value),F=f(n?.data,n);return V.value=!1,te(F)}catch(f){return V.value=!0,`过滤函数错误，日志：${f}`}}),h=()=>{_.value=!0},z=()=>{re({message:"是否删除过滤器",onPositiveCallback:()=>{y.value.filter=void 0}})},C=()=>{_.value=!1},H=()=>{if(V.value){window.$message.error("过滤函数错误，无法进行保存");return}y.value.filter=k.value,C()};return ve(()=>_.value,f=>{f&&(J(),k.value=y.value.filter||"return data")}),(f,n)=>{const F=s("n-code"),q=s("n-icon"),R=s("n-button"),m=s("n-space"),K=s("n-card"),S=s("n-text"),A=s("n-tag"),ne=s("n-divider"),oe=s("n-scrollbar"),$=s("n-modal");return c(),w(U,null,[r(y).filter?(c(),T(K,{key:0},{footer:t(()=>[e(m,{justify:"end"},{default:t(()=>[e(R,{type:"primary",tertiary:"",size:"small",onClick:h},{icon:t(()=>[e(q,null,{default:t(()=>[e(r(G))]),_:1})]),default:t(()=>[n[2]||(n[2]=a(" 编辑 "))]),_:1}),e(R,{tertiary:"",size:"small",onClick:z},{default:t(()=>n[3]||(n[3]=[a(" 删除 ")])),_:1})]),_:1})]),default:t(()=>[n[4]||(n[4]=i("p",null,[i("span",{class:"func-keyword"},"function"),a("  filter(data, res)  {")],-1)),i("div",Ae,[e(F,{code:r(y).filter,language:"typescript"},null,8,["code"])]),n[5]||(n[5]=i("p",null,"}",-1))]),_:1})):(c(),T(R,{key:1,class:"go-ml-3",onClick:h},{icon:t(()=>[e(q,null,{default:t(()=>[e(r(M))]),_:1})]),default:t(()=>[n[6]||(n[6]=a(" 新增过滤器 "))]),_:1})),e($,{class:"go-chart-data-monaco-editor",show:_.value,"onUpdate:show":n[1]||(n[1]=D=>_.value=D),"mask-closable":!1,closeOnEsc:!1},{default:t(()=>[e(K,{bordered:!1,role:"dialog",size:"small","aria-modal":"true",style:{width:"1000px",height:"600px"}},{header:t(()=>[e(m,null,{default:t(()=>[e(S,null,{default:t(()=>n[7]||(n[7]=[a("过滤器函数编辑器")])),_:1})]),_:1})]),"header-extra":t(()=>n[8]||(n[8]=[])),action:t(()=>[e(m,{justify:"space-between"},{default:t(()=>[i("div",Le,[e(A,{bordered:!1,type:"primary"},{icon:t(()=>[e(q,{component:r(d)},null,8,["component"])]),default:t(()=>[n[14]||(n[14]=a(" 规则 "))]),_:1}),e(S,{class:"go-ml-2",depth:"2"},{default:t(()=>n[15]||(n[15]=[a("过滤器默认处理接口返回值的「data」字段")])),_:1})]),e(m,null,{default:t(()=>[e(R,{size:"medium",onClick:C},{default:t(()=>n[16]||(n[16]=[a("取消")])),_:1}),e(R,{size:"medium",type:"primary",onClick:H},{default:t(()=>n[17]||(n[17]=[a("保存")])),_:1})]),_:1})]),_:1})]),default:t(()=>[e(m,{size:"small",vertical:""},{default:t(()=>[e(m,{justify:"space-between"},{default:t(()=>[i("div",null,[e(m,{vertical:""},{default:t(()=>[e(A,{type:"info"},{default:t(()=>n[9]||(n[9]=[i("span",{class:"func-keyword"},"function",-1),a("  filter(data, res)  { ")])),_:1}),e(r(we),{modelValue:k.value,"onUpdate:modelValue":n[0]||(n[0]=D=>k.value=D),width:"460px",height:"380px",language:"javascript"},null,8,["modelValue"]),e(A,{type:"info"},{default:t(()=>n[10]||(n[10]=[a("}")])),_:1})]),_:1})]),e(ne,{vertical:"",style:{height:"480px"}}),e(oe,{style:{"max-height":"480px"}},{default:t(()=>[e(m,{size:15,vertical:""},{default:t(()=>[i("div",De,[e(m,null,{default:t(()=>[e(S,{depth:"3"},{default:t(()=>n[11]||(n[11]=[a("默认过滤数据(data)：")])),_:1}),e(F,{code:r(te)(p.value?.data)||"暂无",language:"json","word-wrap":!0},null,8,["code"])]),_:1})]),i("div",Oe,[e(m,null,{default:t(()=>[e(S,{depth:"3"},{default:t(()=>n[12]||(n[12]=[a("接口返回数据(res)：")])),_:1}),e(F,{code:r(te)(p.value)||"暂无",language:"json","word-wrap":!0},null,8,["code"])]),_:1})]),i("div",Be,[e(m,null,{default:t(()=>[e(S,{depth:"3"},{default:t(()=>n[13]||(n[13]=[a("过滤器结果：")])),_:1}),e(F,{code:E.value||"暂无",language:"json","word-wrap":!0},null,8,["code"])]),_:1})])]),_:1})]),_:1})]),_:1})]),_:1})]),_:1})]),_:1},8,["show"])],64)}}});const Me=ge(Pe,[["__scopeId","data-v-eac7a30e"]]),Ge=N=>{const d=g();return{uploadFileListRef:d,beforeUpload:({file:x})=>{d.value=[];const _=x.file.type;return _!==me.JSON&&_!==me.TXT?(window.$message.warning("仅支持上传 【JSON】 格式文件，请重新上传！"),!1):!0},customRequest:x=>{const{file:_}=x;Ue(()=>{_.file?ze(_.file).then(k=>{N.value.option.dataset=He(k)}):window.$message.error("导入数据失败，请稍后重试或联系管理员！")})},download:()=>{try{window.$message.success("下载中，请耐心等待..."),$e(je(N.value.option.dataset),void 0,"json")}catch{window.$message.error("下载失败，数据错误！")}}}},Je={key:0},Ke={key:1},We={class:"go-flex-items-center"},Xe=_e({__name:"index",props:{show:{type:Boolean,required:!1},ajax:{type:Boolean,required:!0}},setup(N){const{targetData:d}=ye(),M=["字段","映射","状态"],G=["字段","接口映射字段"],{HelpOutlineIcon:y,DocumentTextIcon:x}=le.ionicons5,{DocumentAddIcon:_,DocumentDownloadIcon:k,EditIcon:V}=le.carbon,p=g(),J=g(),E=g(),h=g(!1),z=g(!1),C=g(""),H=g([]),{uploadFileListRef:f,customRequest:n,beforeUpload:F,download:q}=Ge(d),R=ee(()=>d.value.request.requestDataType!==Ie.STATIC),m=ee(()=>d.value.chartConfig.chartFrame===Q.ECHARTS),K=ee(()=>d.value.chartConfig.chartFrame===Q.VCHART),S=u=>{let l=I.SUCCESS;for(let v=0;v<p.value.length;v++)if(p.value[v][u]===void 0)return l=I.FAILURE,l;return I.SUCCESS},A=()=>{try{return J.value.map((u,l)=>l===0?{field:"通用标识",mapping:u,result:I.NULL}:{field:`数据项-${l}`,mapping:u,result:S(u)})}catch{return[]}},ne=()=>{if(d.value?.option){H.value=[];for(const u in d.value.option)if(u.endsWith("Field")){const l=d.value.option[u];d.value.option[u]=l;const v={field:u,mapping:l,result:I.SUCCESS};v.mapping===void 0&&(v.result=I.FAILURE),H.value.push(v)}}},oe=()=>{z.value=!0,d.value.chartConfig.chartKey!=="VHtmlCommon"?C.value=JSON.stringify(p.value,null,2):C.value=p.value},$=()=>{z.value=!1},D=()=>{const u=l=>{d.value.option.dataset=l};re({message:"是否保存编辑后的数据？",onPositiveCallback:()=>{try{let l=C.value;if(d.value.chartConfig.chartKey!=="VHtmlCommon"&&(l=JSON.parse(l)),typeof l!=typeof p.value)re({message:"当前数据类型与原类型不相同, 是否强制应用数据?",onPositiveCallback:()=>{try{u(l),C.value="",window.$message.success("保存成功"),$()}catch{window.$message.error("内容应用错误, 请检查格式是否正确")}}});else try{u(l),C.value="",window.$message.success("保存成功"),$()}catch{window.$message.error("内容应用错误, 请检查格式是否正确")}}catch(l){console.log(l),window.$message.error("内容应用错误, 请检查格式是否正确")}}})};return ve(()=>d.value?.option?.dataset,u=>{h.value=!1,u&&d?.value?.chartConfig?.chartFrame===Q.ECHARTS?(p.value=u,m.value&&(J.value=u.dimensions,E.value=A())):u&&d?.value?.chartConfig?.chartFrame===Q.VCHART?(p.value=u,ne()):u!=null?(E.value=null,p.value=u,H.value=[]):(h.value=!0,p.value="此组件无数据源"),fe(u)&&(E.value=null)},{immediate:!0}),(u,l)=>{const v=s("n-badge"),O=s("n-text"),b=s("n-space"),ue=s("n-table"),W=s("n-timeline-item"),Ce=s("n-ellipsis"),ie=s("n-input"),B=s("n-icon"),L=s("n-button"),be=s("n-upload"),xe=s("n-tooltip"),ke=s("n-code"),he=s("n-card"),Fe=s("n-timeline"),de=s("n-divider"),ae=s("n-tag"),Se=s("n-modal");return c(),w(U,null,[e(Fe,{class:"go-chart-configurations-timeline"},{default:t(()=>[m.value&&E.value?(c(),T(W,{key:0,type:"info",title:r(Z).MAPPING},{default:t(()=>[e(ue,{striped:""},{default:t(()=>[i("thead",null,[i("tr",null,[(c(),w(U,null,P(M,o=>i("th",{key:o},j(o),1)),64))])]),i("tbody",null,[(c(!0),w(U,null,P(E.value,(o,X)=>(c(),w("tr",{key:X},[i("td",null,j(o.field),1),i("td",null,j(o.mapping),1),i("td",null,[o.result===0?(c(),T(b,{key:0},{default:t(()=>[e(v,{dot:"",type:"success"}),e(O,null,{default:t(()=>l[3]||(l[3]=[a("无")])),_:1})]),_:1})):(c(),T(b,{key:1},{default:t(()=>[e(v,{dot:"",type:o.result===1?"success":"error"},null,8,["type"]),e(O,null,{default:t(()=>[a("匹配"+j(o.result===1?"成功":"失败"),1)]),_:2},1024)]),_:2},1024))])]))),128))])]),_:1})]),_:1},8,["title"])):se("",!0),K.value?(c(),T(W,{key:1,type:"info",title:r(Z).MAPPING},{default:t(()=>[e(ue,{striped:""},{default:t(()=>[i("thead",null,[i("tr",null,[(c(),w(U,null,P(G,o=>i("th",{key:o},j(o),1)),64))])]),i("tbody",null,[(c(!0),w(U,null,P(H.value,o=>(c(),w("tr",{key:o.field},[i("td",null,[e(Ce,{style:{width:"70px","max-width":"240px"}},{default:t(()=>[a(j(o.field),1)]),_:2},1024)]),r(fe)(o.mapping)?(c(),w("td",Je,[e(b,{size:4,vertical:""},{default:t(()=>[(c(!0),w(U,null,P(o.mapping,(X,Y)=>(c(),T(ie,{key:Y,value:o.mapping[Y],"onUpdate:value":Te=>o.mapping[Y]=Te,type:"tiny",size:"small",placeholder:"输入字段",onChange:()=>o.result=S(o.mapping[Y])},null,8,["value","onUpdate:value","onChange"]))),128))]),_:2},1024)])):(c(),w("td",Ke,[e(ie,{value:o.mapping,"onUpdate:value":X=>o.mapping=X,type:"text",size:"small",placeholder:"小"},null,8,["value","onUpdate:value"])]))]))),128))])]),_:1})]),_:1},8,["title"])):se("",!0),Ne(e(W,{color:"#97846c",title:r(Z).FILTER},{default:t(()=>[e(b,{size:18,vertical:""},{default:t(()=>[e(O,{depth:"3"},{default:t(()=>l[4]||(l[4]=[a("过滤器默认处理接口返回值的「data」字段")])),_:1}),e(r(Me))]),_:1})]),_:1},8,["title"]),[[Ve,R.value]]),e(W,{type:"success",title:r(Z).CONTENT},{default:t(()=>[e(b,{vertical:""},{default:t(()=>[e(b,{class:"source-btn-box"},{default:t(()=>[e(L,{class:"sourceBtn-item",disabled:h.value,onClick:oe},{icon:t(()=>[e(B,null,{default:t(()=>[e(r(V))]),_:1})]),default:t(()=>[l[5]||(l[5]=a(" 编辑 "))]),_:1},8,["disabled"]),e(be,{"file-list":r(f),"onUpdate:fileList":l[0]||(l[0]=o=>qe(f)?f.value=o:null),"show-file-list":!1,customRequest:r(n),onBeforeUpload:r(F)},{default:t(()=>[e(b,null,{default:t(()=>[N.ajax?se("",!0):(c(),T(L,{key:0,class:"sourceBtn-item",disabled:h.value},{icon:t(()=>[e(B,null,{default:t(()=>[e(r(_))]),_:1})]),default:t(()=>[l[6]||(l[6]=a(" 导入（json / txt） "))]),_:1},8,["disabled"]))]),_:1})]),_:1},8,["file-list","customRequest","onBeforeUpload"]),i("div",null,[e(L,{class:"sourceBtn-item",disabled:h.value,onClick:r(q)},{icon:t(()=>[e(B,null,{default:t(()=>[e(r(k))]),_:1})]),default:t(()=>[l[7]||(l[7]=a(" 下载 "))]),_:1},8,["disabled","onClick"]),e(xe,{trigger:"hover"},{trigger:t(()=>[e(B,{class:"go-ml-1",size:"21",depth:3},{default:t(()=>[e(r(y))]),_:1})]),default:t(()=>[l[8]||(l[8]=i("span",null,"点击【下载】查看完整数据",-1))]),_:1})])]),_:1}),e(he,{size:"small"},{default:t(()=>[e(ke,{code:r(te)(p.value),language:"json"},null,8,["code"])]),_:1})]),_:1})]),_:1},8,["title"])]),_:1}),e(Se,{class:"go-online-edit go-background-filter",title:"组件数据在线编辑 — "+r(d).chartConfig.title,preset:"card",size:"small",style:{width:"800px"},show:z.value,"onUpdate:show":l[2]||(l[2]=o=>z.value=o),"transform-origin":"center","mask-closable":!1,bordered:!0,onAfterLeave:$,"content-style":"padding: 0;"},{action:t(()=>[e(b,{justify:"space-between"},{default:t(()=>[i("div",We,[e(ae,{bordered:!1,type:"primary",style:{"border-radius":"5px"}},{icon:t(()=>[e(B,{component:r(x)},null,8,["component"])]),default:t(()=>[l[9]||(l[9]=a(" 说明 "))]),_:1}),e(b,{"wrap-item":!1,vertical:""},{default:t(()=>[e(O,{class:"go-ml-2",depth:"3",style:{"font-size":"1"}},{default:t(()=>[l[12]||(l[12]=a(" 1. 格式化代码： ")),e(ae,{bordered:!1,type:"warning",style:{"font-size":"12px"}},{default:t(()=>l[10]||(l[10]=[a("( shift + alt + f ) ")])),_:1}),e(de,{vertical:""}),e(ae,{bordered:!1,type:"warning",style:{"font-size":"12px"}},{default:t(()=>l[11]||(l[11]=[a("右键 -> Format Document")])),_:1})]),_:1}),e(O,{class:"go-ml-2",depth:"3",style:{"font-size":"1","text-align":"left"}},{default:t(()=>l[13]||(l[13]=[a(" 2. 字符串需要用英文双引号包裹，否则会报错 ")])),_:1})]),_:1})]),e(b,null,{default:t(()=>[e(L,{class:"go-px-4",focusable:!1,onClick:$},{default:t(()=>l[14]||(l[14]=[a("取消")])),_:1}),e(L,{class:"go-px-4",type:"primary",onClick:D},{default:t(()=>l[15]||(l[15]=[a(" 保存 ")])),_:1})]),_:1})]),_:1})]),default:t(()=>[e(de,{style:{margin:"4px 0 10px"}}),e(we,{modelValue:C.value,"onUpdate:modelValue":l[1]||(l[1]=o=>C.value=o),height:"70vh",language:r(d).chartConfig.chartKey==="VHtmlCommon"?"html":"json"},null,8,["modelValue","language"])]),_:1},8,["title","show"])],64)}}});const st=ge(Xe,[["__scopeId","data-v-7df1053d"]]);export{st as C};
